<html>
    <head>
        <meta charset=utf-8 />
        <script src="bignum.js"></script>
        <script src="gfp.js"></script>
        <script src="ec.js"></script>
        <script src="ecdsa.js"></script>
        <script src="utils.js"></script>
        <script src="jsutils.js"></script>
<script language=javascript>

// a short list of prime numbers.
var primelist = [
2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73,
79, 83, 89, 97, 101, 103, 107, 109, 113, 127, 131, 137, 139, 149, 151, 157,
163, 167, 173, 179, 181, 191, 193, 197, 199, 211, 223, 227, 229, 233, 239, 241,
251, 257, 263, 269, 271, 277, 281, 283, 293, 307, 311, 313, 317, 331, 337, 347,
349, 353, 359, 367, 373, 379, 383, 389, 397, 401, 409, 419, 421, 431, 433, 439,
443, 449, 457, 461, 463, 467, 479, 487, 491, 499, 503, 509, 521, 523, 541, 547,
557, 563, 569, 571, 577, 587, 593, 599, 601, 607, 613, 617, 619, 631, 641, 643,
647, 653, 659, 661, 673, 677, 683, 691, 701, 709, 719, 727, 733, 739, 743, 751,
757, 761, 769, 773, 787, 797, 809, 811, 821, 823, 827, 829, 839, 853, 857, 859,
863, 877, 881, 883, 887, 907, 911, 919, 929, 937, 941, 947, 953, 967, 971, 977,
983, 991, 997 ];

var g_p; var g_a; var g_b;  // the curve parameters.

var ec;         // the curve.

var curvepoints; // the list of all points on the curve.
var g_start;     // the starting point, selected by hovering over the grid.
var g_nrlines=10;   // how many lines to draw from the starting point
var pointlookup = {};

function loadec(p, a, b)
{
    var F = new GaloisField(p);
    ec = new EllipticCurve(F, a, b);
    calcpoints();
    drawgrid();
    drawpath();
    //loadpoints();
}
function calcpoints()
{
    curvepoints = [];
    for (var x = 0 ; x<g_p ; x++)
    {
        var ysquared = x*x*x+g_a*x+g_b;
        var y0 = ec.field.value(ysquared).sqrt(0);
        var y1 = ec.field.value(ysquared).sqrt(1);
        if (typeof(y0)!="undefined")
        {
            curvepoints.push(ec.point(x, y0));
            if (!y0.equals(y1))
                curvepoints.push(ec.point(x, y1));
        }
    }
    //g_start = curvepoints[Math.floor(curvepoints.length/2)];

    for (var pt of curvepoints)
        pointlookup[indexkey(pt)] = pt;
}
function indexkey(p)
{
    return "("+Math.round(p.x.uint()/5).toString(10)+","+Math.round(p.y.uint()/5).toString(10)+")";
}
function findpoint(x, y)
{
    var ix = "("+Math.round(x/5).toString(10)+","+Math.round(y/5).toString(10)+")";
    return pointlookup[ix];
}
function drawpoint(ctx, pt)
{
    ctx.fillRect(pt.x.uint()-1, pt.y.uint()-1, 3, 3);
}
function startline(ctx, p)
{
    ctx.moveTo(p.x.uint(), p.y.uint());
}
function drawlineto(ctx, p)
{
    if (typeof(p.x)=="undefined")
        return;
    ctx.lineTo(p.x.uint(), p.y.uint());
}

function drawgrid()
{
    setnrpoints(curvepoints.length);
    var canvas = document.getElementById("points");
    canvas.width = g_p;
    canvas.height = g_p;

    var ctx = canvas.getContext("2d")
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    for (var pt of curvepoints)
    {
        drawpoint(ctx, pt);
    }
}
function drawpath()
{
    if (!g_start) return;

    var canvas = document.getElementById("points");
    var ctx = canvas.getContext("2d")

    ctx.beginPath();
    
    var p = g_start;
    startline(ctx, g_start);
    for (var i=0 ; i<g_nrlines ; i++)
    {
        p = p.add(g_start);
        drawlineto(ctx, p);
    }
    ctx.stroke();
}

function loadpoints()
{
    for (var a of curvepoints)
        for (var b of curvepoints)
        {
        }
}
function update()
{
    loadec(g_p, g_a, g_b);
}
function makesliders()
{
    return [
        makeslider("prime:", "prime", 0, primelist.length-1, Math.round(primelist.length/5), t => { g_p = primelist[Number(t)]; }, ()=>g_p),
        makeslider("a:", "a", -16, 16, 0, t=>{ g_a = Number(t); }, ()=>g_a),
        makeslider("b:", "b", -16, 16, 7, t=>{ g_b = Number(t); }, ()=>g_b),
        makeslider("nlines:", "n", 0, 1000, 10, t=>{ g_nrlines = Number(t); }, ()=>g_nrlines),
    ];
}
function start()
{
    var div = document.getElementById("controlsdiv");
    div.append(...makesliders());

    var fp = document.getElementById("points");
    fp.onmousemove = function(e) {
            var pt = findpoint(e.offsetX, e.offsetY);
            if (pt) {
                g_start = pt;
                update();
            }
        };

    update();
}
function setnrpoints(n)
{
    var av =document.getElementById("order.value"); 
    av.innerHTML = n;
}

</script>
    </head>
    <body onLoad="start()">
<a href="bitcoincrack.html">crack demo</a> <a href="curve.html">curve demo</a> <a href="unittest.html">unittest</a>
<div id="controlsdiv"></div>
<div>
<span>order:</span> <span id="order.value"></span>
</div>

<table>
    <tr>
        <td>
<canvas id="points"></canvas>
        </td>
        <td>
        </td>
    </tr>
</table>
<div id="xygrid"></div>
<div id="ptgrid"></div>
    </body>
</html>

